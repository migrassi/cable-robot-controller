<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cable Robot Controller</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <h1>Cable Robot Controller</h1>
            <div class="status-bar">
                <div class="connection-status" id="connectionStatus">
                    <span class="status-dot simulation"></span>
                    <button id="modeToggle" class="mode-toggle-btn">SIMULATION MODE</button>
                </div>
                <div class="safety-controls">
                    <button id="systemActivate" class="safety-btn activate">ACTIVATE SYSTEM</button>
                    <button id="emergencyStop" class="emergency-btn">EMERGENCY STOP</button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Left Panel: 3D Viewport -->
            <div class="left-panel">
                <!-- 3D Viewport -->
                <section class="viewport-section">
                    <div class="panel-header">
                        <h2>3D Workspace</h2>
                        <div class="view-controls">
                            <button id="resetView" class="view-btn">Reset View</button>
                            <button id="topView" class="view-btn">Top View</button>
                            <button id="sideView" class="view-btn">Side View</button>
                            <button id="frontView" class="view-btn">Front View</button>
                        </div>
                    </div>
                    <div id="viewport" class="viewport">
                        <!-- Coordinate overlay on viewport -->
                        <div class="viewport-overlay">
                            <div class="coord-display">
                                <div class="coord-item">
                                    <span class="coord-label">X:</span>
                                    <span class="coord-value" id="overlayPosX">0.00</span>
                                    <span class="coord-unit">m</span>
                                </div>
                                <div class="coord-item">
                                    <span class="coord-label">Y:</span>
                                    <span class="coord-value" id="overlayPosY">0.00</span>
                                    <span class="coord-unit">m</span>
                                </div>
                                <div class="coord-item">
                                    <span class="coord-label">Z:</span>
                                    <span class="coord-value" id="overlayPosZ">2.50</span>
                                    <span class="coord-unit">m</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Center Panel: Movement Controls -->
            <div class="center-panel">
                <!-- Movement Controls -->
                <section class="controls-section-vertical">
                    <div class="panel-header">
                        <h2>Movement Controls</h2>
                        <div class="control-status">
                            <span id="systemStatus" class="status-inactive">SYSTEM INACTIVE</span>
                        </div>
                    </div>
                    <div class="controls-vertical">
                        <div class="control-group-vertical">
                            <h3>X Axis</h3>
                            <div class="button-row">
                                <button class="move-btn" data-axis="x" data-direction="-1" disabled>‚Üê LEFT</button>
                                <button class="move-btn" data-axis="x" data-direction="1" disabled>RIGHT ‚Üí</button>
                            </div>
                            <input type="range" id="xSlider" min="-2.5" max="2.5" value="0" step="0.1" disabled>
                        </div>
                        
                        <div class="control-group-vertical">
                            <h3>Y Axis</h3>
                            <div class="button-row">
                                <button class="move-btn" data-axis="y" data-direction="1" disabled>‚Üë FRONT</button>
                                <button class="move-btn" data-axis="y" data-direction="-1" disabled>‚Üì BACK</button>
                            </div>
                            <input type="range" id="ySlider" min="-2.5" max="2.5" value="0" step="0.1" disabled>
                        </div>
                        
                        <div class="control-group-vertical">
                            <h3>Z Axis (Height)</h3>
                            <div class="button-row">
                                <button class="move-btn" data-axis="z" data-direction="1" disabled>‚Üë UP</button>
                                <button class="move-btn" data-axis="z" data-direction="-1" disabled>‚Üì DOWN</button>
                            </div>
                            <input type="range" id="zSlider" min="0.5" max="4.5" value="2.5" step="0.1" disabled>
                        </div>
                        
                        <div class="control-group-vertical">
                            <h3>Quick Positions</h3>
                            <div class="button-row">
                                <button class="quick-btn" onclick="goToPosition(0, 0, 2.5)" disabled>Center</button>
                                <button class="quick-btn" onclick="goToPosition(1, 1, 3)" disabled>High</button>
                            </div>
                            <div class="button-row">
                                <button class="quick-btn" onclick="goToPosition(-1, -1, 1)" disabled>Low</button>
                                <button class="quick-btn" onclick="goToPosition(0, 0, 4)" disabled>Top</button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right Panel: Camera and Status -->
            <div class="right-panel">
                <!-- Camera Monitor -->
                <section class="camera-section">
                    <div class="panel-header">
                        <h2>Camera Monitor</h2>
                        <div class="camera-controls">
                            <button id="fullscreenCamera" disabled title="Fullscreen View">‚õ∂</button>
                            <button id="snapshot" disabled title="Take Snapshot">üì∑</button>
                            <button id="recordToggle" disabled title="Start/Stop Recording">‚è∫Ô∏è</button>
                            <button id="stopCamera" disabled title="Stop Camera">‚èπÔ∏è</button>
                        </div>
                    </div>
                    <div class="camera-container">
                        <div class="camera-placeholder">
                            <div class="no-signal">
                                <span>üìπ</span>
                                <p>Camera Ready</p>
                                <small>Activate system to enable webcam</small>
                            </div>
                        </div>
                        <div class="camera-overlay">
                            <div class="crosshair"></div>
                            <div class="camera-info">
                                <span id="cameraResolution">1920x1080</span>
                                <span id="cameraFPS">30 FPS</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- System Status -->
                <section class="status-section">
                    <div class="panel-header">
                        <h2>System Status</h2>
                    </div>
                    <div class="status-items">
                        <div class="status-item">
                            <span class="label">Robot Status:</span>
                            <span class="value" id="robotStatus">Inactive</span>
                        </div>
                        <div class="status-item">
                            <span class="label">System Power:</span>
                            <span class="value" id="systemPower">OFF</span>
                        </div>
                        <div class="status-item">
                            <span class="label">Safety Status:</span>
                            <span class="value" id="safetyStatus">SAFE</span>
                        </div>
                        <div class="status-item">
                            <span class="label">Cable Tension:</span>
                            <span class="value" id="cableTension">-</span>
                        </div>
                        <div class="status-item">
                            <span class="label">Position:</span>
                            <span class="value" id="positionStatus">Center</span>
                        </div>
                        <div class="status-item">
                            <span class="label">Last Command:</span>
                            <span class="value" id="lastCommand">System Standby</span>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Fullscreen Camera Modal -->
        <div id="fullscreenModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div class="fullscreen-camera-placeholder">
                    <span>üìπ</span>
                    <p>Camera Monitor</p>
                </div>
            </div>
        </div>

    <script src="js/three-setup.js"></script>
    <script src="js/js_websocket-client.js"></script>
    <script>
        // Cable Robot Controller - Hybrid Mode (Simulation + Hardware)
        let robotVisualization;
        let systemActive = false;
        let emergencyStop = false;
        let isHardwareConnected = false;
        let hardwareModeEnabled = false; // User preference for hardware connection

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing Cable Robot Controller (Hybrid Mode)...');
            
            // Initialize 3D visualization
            robotVisualization = new RobotVisualization('viewport');
            
            // Initialize position displays with default values
            updatePositionDisplay(0, 0, 2.5);
            
            // Setup controls and safety systems
            setupSafetyControls();
            setupMovementControls();
            setupViewControls();
            setupCameraSystem();
            setupWebSocketIntegration();
            
            // Start status updates
            updateSystemStatus();
            setInterval(updateSystemStatus, 1000);
            
            console.log('Controller initialized successfully');
        });

        function setupSafetyControls() {
            // System Activation
            document.getElementById('systemActivate').addEventListener('click', () => {
                if (emergencyStop) {
                    showNotification('Clear emergency stop first!', 'warning');
                    return;
                }
                
                systemActive = !systemActive;
                const btn = document.getElementById('systemActivate');
                
                if (systemActive) {
                    btn.textContent = 'DEACTIVATE SYSTEM';
                    btn.className = 'safety-btn deactivate';
                    enableControls();
                    showNotification('System Activated', 'success');
                    updateLastCommand('System Activated');
                    
                    // Send activation command to hardware if connected
                    if (isHardwareConnected) {
                        sendToHardware('activate')
                            .catch((error) => {
                                console.error('Hardware activation failed:', error);
                                showNotification('Hardware activation failed', 'warning');
                            });
                    }
                } else {
                    btn.textContent = 'ACTIVATE SYSTEM';
                    btn.className = 'safety-btn activate';
                    disableControls();
                    showNotification('System Deactivated', 'info');
                    updateLastCommand('System Deactivated');
                    
                    // Send deactivation command to hardware if connected
                    if (isHardwareConnected) {
                        sendToHardware('deactivate')
                            .catch((error) => {
                                console.error('Hardware deactivation failed:', error);
                            });
                    }
                }
            });

            // Emergency Stop
            document.getElementById('emergencyStop').addEventListener('click', () => {
                emergencyStop = true;
                systemActive = false;
                
                // Reset activation button
                const activateBtn = document.getElementById('systemActivate');
                activateBtn.textContent = 'ACTIVATE SYSTEM';
                activateBtn.className = 'safety-btn activate';
                
                disableControls();
                showNotification('EMERGENCY STOP ACTIVATED!', 'error');
                updateLastCommand('EMERGENCY STOP');
                
                // Send emergency stop to hardware immediately if connected
                if (isHardwareConnected) {
                    sendToHardware('emergency_stop')
                        .then(() => {
                            console.log('Emergency stop sent to hardware');
                        })
                        .catch((error) => {
                            console.error('Emergency stop command failed:', error);
                        });
                }
                
                // Auto-clear after 5 seconds in simulation mode only
                if (!isHardwareConnected) {
                    setTimeout(() => {
                        emergencyStop = false;
                        showNotification('Emergency stop cleared (simulation)', 'info');
                    }, 5000);
                }
            });
        }

        function setupMovementControls() {
            // Movement buttons
            document.querySelectorAll('.move-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (!systemActive || emergencyStop) return;
                    
                    const axis = e.target.dataset.axis;
                    const direction = parseFloat(e.target.dataset.direction);
                    const step = 0.3;
                    
                    if (robotVisualization) {
                        const currentPos = robotVisualization.getRobotPosition();
                        let newX = currentPos.x;
                        let newY = currentPos.y; 
                        let newZ = currentPos.z;
                        
                        if (axis === 'x') newX += direction * step;
                        if (axis === 'y') newY += direction * step;
                        if (axis === 'z') newZ += direction * step;
                        
                        // Apply workspace limits
                        newX = Math.max(-2.5, Math.min(2.5, newX));
                        newY = Math.max(-2.5, Math.min(2.5, newY));
                        newZ = Math.max(0.5, Math.min(4.5, newZ));
                        
                        robotVisualization.setRobotPosition(newX, newY, newZ);
                        updatePositionDisplay(newX, newY, newZ);
                        updateSliders(newX, newY, newZ);
                        updateLastCommand(`Move ${axis.toUpperCase()}: ${direction > 0 ? '+' : ''}${(direction * step).toFixed(1)}m`);
                        
                        // Send command to hardware if connected
                        if (isHardwareConnected) {
                            sendToHardware('move', { x: newX, y: newY, z: newZ })
                                .catch((error) => {
                                    console.error('Hardware move command failed:', error);
                                    showNotification('Hardware command failed', 'warning');
                                });
                        }
                    }
                });
            });

            // Sliders
            ['x', 'y', 'z'].forEach(axis => {
                const slider = document.getElementById(axis + 'Slider');
                if (slider) {
                    slider.addEventListener('input', (e) => {
                        if (!systemActive || emergencyStop) return;
                        
                        if (robotVisualization) {
                            const currentPos = robotVisualization.getRobotPosition();
                            const newValue = parseFloat(e.target.value);
                            
                            let newX = currentPos.x;
                            let newY = currentPos.y;
                            let newZ = currentPos.z;
                            
                            if (axis === 'x') newX = newValue;
                            if (axis === 'y') newY = newValue;
                            if (axis === 'z') newZ = newValue;
                            
                            robotVisualization.setRobotPosition(newX, newY, newZ);
                            updatePositionDisplay(newX, newY, newZ);
                            updateLastCommand(`Set ${axis.toUpperCase()}: ${newValue.toFixed(2)}m`);
                            
                            // Send command to hardware if connected
                            if (isHardwareConnected) {
                                sendToHardware('move', { x: newX, y: newY, z: newZ })
                                    .catch((error) => {
                                        console.error('Hardware move command failed:', error);
                                    });
                            }
                        }
                    });
                }
            });
        }

        function setupViewControls() {
            // View control buttons
            document.getElementById('resetView')?.addEventListener('click', () => {
                if (robotVisualization) {
                    robotVisualization.resetCameraView();
                    showNotification('Camera view reset', 'info');
                }
            });
            
            document.getElementById('topView')?.addEventListener('click', () => {
                if (robotVisualization) {
                    robotVisualization.setTopView();
                    showNotification('Top view activated', 'info');
                }
            });
            
            document.getElementById('sideView')?.addEventListener('click', () => {
                if (robotVisualization) {
                    robotVisualization.setSideView();
                    showNotification('Side view activated', 'info');
                }
            });
            
            document.getElementById('frontView')?.addEventListener('click', () => {
                if (robotVisualization) {
                    robotVisualization.setFrontView();
                    showNotification('Front view activated', 'info');
                }
            });
        }

        function setupCameraSystem() {
            let cameraStream = null;
            let isRecording = false;
            let mediaRecorder = null;
            let recordedChunks = [];

            // Initialize camera access
            async function initializeCamera() {
                try {
                    const constraints = {
                        video: {
                            width: { ideal: 1920 },
                            height: { ideal: 1080 },
                            frameRate: { ideal: 30 }
                        },
                        audio: false
                    };

                    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // Replace placeholder with video element
                    const cameraContainer = document.querySelector('.camera-container');
                    const videoElement = document.createElement('video');
                    videoElement.id = 'cameraVideo';
                    videoElement.autoplay = true;
                    videoElement.muted = true;
                    videoElement.style.width = '100%';
                    videoElement.style.height = '100%';
                    videoElement.style.objectFit = 'cover';
                    videoElement.style.borderRadius = '8px';
                    
                    // Replace placeholder
                    const placeholder = cameraContainer.querySelector('.camera-placeholder');
                    if (placeholder) {
                        cameraContainer.removeChild(placeholder);
                    }
                    cameraContainer.appendChild(videoElement);
                    
                    videoElement.srcObject = cameraStream;
                    
                    // Update camera info with actual stream info
                    const videoTrack = cameraStream.getVideoTracks()[0];
                    const settings = videoTrack.getSettings();
                    document.getElementById('cameraResolution').textContent = `${settings.width}x${settings.height}`;
                    document.getElementById('cameraFPS').textContent = `${settings.frameRate || 30} FPS`;
                    
                    // Enable camera controls
                    document.getElementById('fullscreenCamera').disabled = false;
                    document.getElementById('snapshot').disabled = false;
                    document.getElementById('recordToggle').disabled = false;
                    document.getElementById('stopCamera').disabled = false;
                    
                    showNotification('Camera initialized successfully', 'success');
                    
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    showNotification('Camera access denied or not available', 'error');
                    
                    // Update placeholder to show error
                    const placeholder = document.querySelector('.camera-placeholder .no-signal p');
                    if (placeholder) {
                        placeholder.textContent = 'Camera Access Denied';
                        placeholder.nextElementSibling.textContent = 'Check browser permissions';
                    }
                }
            }

            // Stop camera stream
            function stopCamera() {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                    
                    // Replace video with placeholder
                    const cameraContainer = document.querySelector('.camera-container');
                    const videoElement = document.getElementById('cameraVideo');
                    if (videoElement) {
                        cameraContainer.removeChild(videoElement);
                    }
                    
                    // Restore placeholder
                    const placeholder = document.createElement('div');
                    placeholder.className = 'camera-placeholder';
                    placeholder.innerHTML = `
                        <div class="no-signal">
                            <span>üìπ</span>
                            <p>Camera Ready</p>
                            <small>Activate system to enable webcam</small>
                        </div>
                    `;
                    cameraContainer.appendChild(placeholder);
                    
                    // Disable camera controls
                    document.getElementById('fullscreenCamera').disabled = true;
                    document.getElementById('snapshot').disabled = true;
                    document.getElementById('recordToggle').disabled = true;
                    document.getElementById('stopCamera').disabled = true;
                    
                    showNotification('Camera stopped', 'info');
                }
            }

            // Take snapshot
            function takeSnapshot() {
                const video = document.getElementById('cameraVideo');
                if (!video) return;
                
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                // Create download link
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `snapshot_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showNotification('Snapshot saved', 'success');
                });
            }

            // Toggle recording
            function toggleRecording() {
                if (!cameraStream) return;

                if (!isRecording) {
                    // Start recording
                    recordedChunks = [];
                    mediaRecorder = new MediaRecorder(cameraStream);
                    
                    mediaRecorder.ondataavailable = event => {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(recordedChunks, { type: 'video/webm' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `recording_${new Date().toISOString().replace(/[:.]/g, '-')}.webm`;
                        a.click();
                        URL.revokeObjectURL(url);
                        showNotification('Recording saved', 'success');
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    document.getElementById('recordToggle').textContent = '‚èπÔ∏è';
                    showNotification('Recording started', 'info');
                    
                } else {
                    // Stop recording
                    mediaRecorder.stop();
                    isRecording = false;
                    document.getElementById('recordToggle').textContent = '‚è∫Ô∏è';
                    showNotification('Recording stopped', 'info');
                }
            }

            // Camera controls event listeners
            document.getElementById('fullscreenCamera')?.addEventListener('click', () => {
                if (systemActive && cameraStream) {
                    const modal = document.getElementById('fullscreenModal');
                    const fullscreenContainer = modal.querySelector('.fullscreen-camera-placeholder');
                    
                    // Clone video element for fullscreen
                    const video = document.getElementById('cameraVideo');
                    if (video) {
                        const fullscreenVideo = video.cloneNode(true);
                        fullscreenVideo.id = 'fullscreenVideo';
                        fullscreenVideo.srcObject = cameraStream;
                        
                        fullscreenContainer.innerHTML = '';
                        fullscreenContainer.appendChild(fullscreenVideo);
                        modal.style.display = 'block';
                    }
                } else {
                    showNotification('Activate system and camera first', 'warning');
                }
            });
            
            document.getElementById('snapshot')?.addEventListener('click', () => {
                if (systemActive && cameraStream) {
                    takeSnapshot();
                } else {
                    showNotification('Activate system and camera first', 'warning');
                }
            });
            
            document.getElementById('recordToggle')?.addEventListener('click', () => {
                if (systemActive && cameraStream) {
                    toggleRecording();
                } else {
                    showNotification('Activate system and camera first', 'warning');
                }
            });

            document.getElementById('stopCamera')?.addEventListener('click', () => {
                if (cameraStream) {
                    stopCamera();
                } else {
                    showNotification('Camera is not active', 'warning');
                }
            });

            // Close modal event listeners
            document.querySelector('#fullscreenModal .close')?.addEventListener('click', () => {
                document.getElementById('fullscreenModal').style.display = 'none';
                // Clean up fullscreen video
                const fullscreenContainer = document.querySelector('.fullscreen-camera-placeholder');
                if (fullscreenContainer) {
                    fullscreenContainer.innerHTML = `
                        <span>üìπ</span>
                        <p>Camera Monitor</p>
                    `;
                }
            });

            // Also close modal when clicking outside of it
            document.getElementById('fullscreenModal')?.addEventListener('click', (e) => {
                if (e.target.id === 'fullscreenModal') {
                    document.getElementById('fullscreenModal').style.display = 'none';
                    // Clean up fullscreen video
                    const fullscreenContainer = document.querySelector('.fullscreen-camera-placeholder');
                    if (fullscreenContainer) {
                        fullscreenContainer.innerHTML = `
                            <span>üìπ</span>
                            <p>Camera Monitor</p>
                        `;
                    }
                }
            });

            // Expose functions to global scope for system control
            window.cameraSystem = {
                initialize: initializeCamera,
                stop: stopCamera,
                isActive: () => !!cameraStream
            };
        }

        function goToPosition(x, y, z) {
            if (!systemActive || emergencyStop) {
                showNotification('System not active', 'warning');
                return;
            }
            
            // Update simulation visualization
            if (robotVisualization) {
                robotVisualization.setRobotPosition(x, y, z);
                updatePositionDisplay(x, y, z);
                updateSliders(x, y, z);
                updateLastCommand(`Go to position: (${x}, ${y}, ${z})`);
                
                // Show different message based on connection status
                const modeText = isHardwareConnected ? 'hardware + simulation' : 'simulation';
                showNotification(`Moving to position (${x}, ${y}, ${z}) [${modeText}]`, 'info');
            }
            
            // Send command to hardware if connected
            if (isHardwareConnected) {
                sendToHardware('move', { x, y, z })
                    .then(() => {
                        console.log('Hardware move command sent successfully');
                    })
                    .catch((error) => {
                        console.error('Hardware move command failed:', error);
                        showNotification('Hardware command failed: ' + error.message, 'warning');
                    });
            }
        }

        function enableControls() {
            document.querySelectorAll('.move-btn, .quick-btn, input[type="range"]').forEach(el => {
                el.disabled = false;
            });
            
            // Initialize camera when system is activated
            if (window.cameraSystem && !window.cameraSystem.isActive()) {
                window.cameraSystem.initialize();
            }
        }

        function disableControls() {
            document.querySelectorAll('.move-btn, .quick-btn, input[type="range"]').forEach(el => {
                el.disabled = true;
            });
            document.querySelectorAll('#fullscreenCamera, #snapshot, #recordToggle, #stopCamera').forEach(el => {
                el.disabled = true;
            });
            
            // Stop camera when system is deactivated
            if (window.cameraSystem && window.cameraSystem.isActive()) {
                window.cameraSystem.stop();
            }
        }

        function setupWebSocketIntegration() {
            // Setup mode toggle button
            const modeToggleBtn = document.getElementById('modeToggle');
            if (modeToggleBtn) {
                modeToggleBtn.addEventListener('click', () => {
                    if (isHardwareConnected) {
                        // Disconnect from hardware
                        if (window.websocketClient) {
                            window.websocketClient.disconnect();
                            showNotification('Disconnected from hardware - entering simulation mode', 'info');
                        }
                    } else {
                        // Try to connect to hardware
                        if (window.websocketClient) {
                            window.websocketClient.reconnect();
                            showNotification('Attempting to connect to hardware...', 'info');
                        }
                    }
                });
            }
            
            // Wait for WebSocket to be available
            setTimeout(() => {
                if (window.websocketClient) {
                    // Completely override WebSocket client's updateConnectionStatus
                    window.websocketClient.updateConnectionStatus = function() {
                        // We handle this with our own updateConnectionStatusDisplay function
                        // Just update our internal state
                        isHardwareConnected = this.isConnected;
                        updateConnectionStatusDisplay();
                    };

                    // Initial status update
                    updateConnectionStatusDisplay();
                }
            }, 100);
        }

        function updateConnectionStatusDisplay() {
            const statusDot = document.querySelector('.status-dot');
            const statusBtn = document.getElementById('modeToggle');
            
            if (statusDot && statusBtn) {
                if (isHardwareConnected) {
                    statusDot.className = 'status-dot online';
                    statusBtn.textContent = 'HARDWARE CONNECTED';
                    statusBtn.title = 'Click to disconnect and use simulation only';
                } else {
                    statusDot.className = 'status-dot simulation';
                    statusBtn.textContent = 'SIMULATION MODE';
                    statusBtn.title = 'Click to attempt hardware connection';
                }
            }
        }

        function sendToHardware(command, data = {}) {
            if (isHardwareConnected && window.websocketClient) {
                return window.websocketClient.sendCommand(command, data);
            }
            return Promise.resolve(); // Return resolved promise for simulation mode
        }

        function updatePositionDisplay(x, y, z) {
            // Update viewport overlay display
            document.getElementById('overlayPosX').textContent = x.toFixed(2);
            document.getElementById('overlayPosY').textContent = y.toFixed(2);
            document.getElementById('overlayPosZ').textContent = z.toFixed(2);
        }

        function updateSliders(x, y, z) {
            document.getElementById('xSlider').value = x;
            document.getElementById('ySlider').value = y;
            document.getElementById('zSlider').value = z;
        }

        function updateSystemStatus() {
            // Update status indicators
            document.getElementById('systemStatus').textContent = systemActive ? 'SYSTEM ACTIVE' : 'SYSTEM INACTIVE';
            document.getElementById('systemStatus').className = systemActive ? 'status-active' : 'status-inactive';
            
            document.getElementById('robotStatus').textContent = emergencyStop ? 'EMERGENCY STOP' : (systemActive ? 'Ready' : 'Inactive');
            document.getElementById('systemPower').textContent = systemActive ? 'ON' : 'OFF';
            document.getElementById('safetyStatus').textContent = emergencyStop ? 'EMERGENCY' : 'SAFE';
            document.getElementById('cableTension').textContent = systemActive ? 'Normal' : '-';
            
            // Update position status
            if (robotVisualization) {
                const pos = robotVisualization.getRobotPosition();
                const isCenter = Math.abs(pos.x) < 0.1 && Math.abs(pos.y) < 0.1;
                document.getElementById('positionStatus').textContent = isCenter ? 'Center' : `(${pos.x.toFixed(1)}, ${pos.y.toFixed(1)}, ${pos.z.toFixed(1)})`;
            }
        }

        function updateLastCommand(command) {
            document.getElementById('lastCommand').textContent = command;
        }

        function showNotification(message, type = 'info') {
            // Simple notification system
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>